% ----------------------------------------------------------------------------
%
% quthesis.sty
% A PhD thesis style class for the Queensland University of Technology
%
% Hilton Bristow
% 2014
%
% Options:
%   print: Print binding offsets of 0.5in are added to the inner edge, and
%     hyperlink coloring is disabled
%   onehalfspacing: Increase line spacing in the mainmatter
%   strict: Comply with the QUT style guidelines
%   relaxed: Remove material that isn't of interest to the reader, but also
%		breaks compliance with the official QUT guidelines
%
% ----------------------------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{quthesis}[01/09/14 QUT PhD Thesis Style]

% ----------------------------------------------------------------------------
% Required Packages
% ----------------------------------------------------------------------------
\RequirePackage[usenames,dvipsnames]{xcolor}
\RequirePackage{ifthen}
\RequirePackage{ifxetex}
\RequirePackage{fancyhdr}
\RequirePackage{setspace}
\RequirePackage{graphicx}
\RequirePackage{xspace}
\RequirePackage{xparse}
\RequirePackage{wallpaper}
\RequirePackage{anyfontsize}
\RequirePackage[text={4.9in,8.6in},centering,bindingoffset=0in]{geometry}
\RequirePackage[ocgcolorlinks,pagebackref=true,bookmarks=true]{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=RoyalBlue,
    citecolor=RedViolet,
    urlcolor=RoyalBlue
}


% ----------------------------------------------------------------------------
% Conditionals
% ----------------------------------------------------------------------------
\newif\ifprint\printfalse
\newif\ifstrict\stricttrue
\newif\ifcalendas\calendasfalse
\newif\ifdropcaps\dropcapsfalse

% ----------------------------------------------------------------------------
% Options
% ----------------------------------------------------------------------------
\DeclareOption{print}{
    \newgeometry{text={4.9in,8.6in},centering,bindingoffset=0.3in}
    \hypersetup{
        colorlinks=false,
        linkcolor=black,
        citecolor=black,
        urlcolor=black
    }
    \printtrue
}

\DeclareOption{onehalfspacing}{
    \let\builtinmainmatter\mainmatter
    \renewcommand{\mainmatter}{\builtinmainmatter\onehalfspacing}
}

\DeclareOption{strict}{\stricttrue}
\DeclareOption{relaxed}{\strictfalse}
\DeclareOption{calendas}{\calendastrue}
\DeclareOption{dropcaps}{\dropcapstrue}

\ProcessOptions\relax

% ----------------------------------------------------------------------------
% Author Information
% ----------------------------------------------------------------------------
\makeatletter
\newcommand\subtitle[1]{\renewcommand\@subtitle{#1\xspace}}
\newcommand\@subtitle{}
\newcommand\email[1]{\renewcommand\@email{\href{mailto:#1}{#1}\xspace}}
\newcommand\@email{}
\newcommand\university[1]{\renewcommand\@university{#1\xspace}}
\newcommand\@university{}
\newcommand\department[1]{\renewcommand\@department{#1\xspace}}
\newcommand\@department{}
\newcommand\qualifications[1]{\renewcommand\@qualifications{#1\xspace}}
\newcommand\@qualifications{}
\newcommand\degree[1]{\renewcommand\@degree{#1\xspace}}
\newcommand\@degree{}
\newcommand\supervisor[1]{\renewcommand\@supervisor{#1\xspace}}
\newcommand\@supervisor{}
\newcommand\keywords[1]{\renewcommand\@keywords{#1}}
\newcommand\@keywords{}

% ----------------------------------------------------------------------------
% PDF Metadata
% ----------------------------------------------------------------------------
\AtBeginDocument{
    \hypersetup{
        pdftitle=\@title,
        pdfauthor=\@author,
        pdfsubject=\degree\xspace Dissertation,
        pdfkeywords=\@keywords
    }
}

% ----------------------------------------------------------------------------
% Fonts
% ----------------------------------------------------------------------------
\ifxetex
    \RequirePackage[bf]{titlesec}
    \RequirePackage{fontspec}
    \ifcalendas
        % Calendas Font
        \newfontfamily\calendas{Calendas Plus}
    \else
        % Hoefler Text fallback (OS X), Windows users should change this to Georgia
        \newfontfamily\calendas{Hoefler Text}
    \fi
    \titleformat*{\chapter}{\LARGE\calendas}
    \titleformat*{\section}{\LARGE\calendas}
    \titleformat*{\subsection}{\Large\calendas}
    \titleformat*{\subsubsection}{\large\calendas}
\else
    % fallback to bold Computer Modern
    \newcommand{\calendas}{\bf}
\fi
  
% ----------------------------------------------------------------------------
% Title
% ----------------------------------------------------------------------------
\renewcommand{\maketitle}{

    \thispagestyle{empty}
    \begin{center}
        \topskip0pt
        \vspace*{\fill}\vspace{-30mm}
        \Huge{\fontsize{1.8em}{2em}\selectfont \calendas \@title}\\\vspace{5mm}
        \Huge{\fontsize{1em}{1em}\selectfont \calendas \@subtitle}\\
        \ifstrict
            \vspace{12mm}
            \large{\emph{by}\\\medskip \textbf{\@author}}\\
            \@qualifications
            \medskip\\\@department\\\@university\\
            \vspace*{\fill}
            A dissertation submitted in partial fulfilment\\ of the requirements for the degree of\\\@degree\\
            \medskip
            \normalsize
            \@date
        \else
            \vspace{2in}
            \Large{\calendas \@author\\\vspace{0.2in} \the\year}
            \vspace*{\fill}
        \fi
    \end{center}
    \clearpage

    \thispagestyle{empty}
    \begin{center}
        \vspace*{\fill}
        \ifstrict
            \textbf{Keywords:} \@keywords.
        \else
            A thesis submitted for the degree of \@degree at\\\@university
        \fi
    \end{center}
    \clearpage
}

% ----------------------------------------------------------------------------
% Header Style
% ----------------------------------------------------------------------------
\fancypagestyle{custom}{
    \fancyhf{}
    \fancyhf[HLO]{\slshape\nouppercase{\leftmark}}
    \fancyhf[HLE,HRO]{\thepage}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}
\pagestyle{custom} 
\renewcommand{\chaptermark}[1]{\markboth{#1}{}}

% ----------------------------------------------------------------------------
% Automatic Dropcaps
% ----------------------------------------------------------------------------
\ifdropcaps
    \RequirePackage{lettrine}
    \setlength{\DefaultNindent}{0em}
    \renewcommand{\LettrineFontHook}{\calendas}
\fi


% ----------------------------------------------------------------------------
% Code environment
% ----------------------------------------------------------------------------
\RequirePackage{listings}
\lstset{
  basicstyle=\ttfamily,
  backgroundcolor=\color{gray!2},
  basewidth={0.5em,0.45em},
  frame=single,
  framerule=0pt,
  emph={},
  emphstyle=\bfseries
}

% rename environments
\let\codeblock\lstlisting
\let\code\lstinline


% ----------------------------------------------------------------------------
% Tight Itemize Environment
% ---------------------------------------------------------------------------
\newenvironment{tightemize}
    {\begin{itemize}
        \setlength{\itemsep}{2pt}
        \setlength{\parskip}{0pt}
        \setlength{\parsep}{0pt}}
    {\end{itemize}}


% ----------------------------------------------------------------------------
% Quote Environment
% ----------------------------------------------------------------------------
\DeclareDocumentEnvironment{quote}{ O{} O{center} }%
    { \begin{#2} \begin{minipage}{0.8\textwidth} \it }%
    { \ifthenelse{\equal{#1}{}}{}{\par\raggedleft\textsc{-- #1}}%
      \end{minipage}\end{#2}\par\@afterindentfalse\@afterheading }


% ----------------------------------------------------------------------------
% Abbreviations
% ----------------------------------------------------------------------------
\DeclareRobustCommand\onedot{\futurelet\@let@token\@onedot}
\def\@onedot{\ifx\@let@token.\else.\null\fi\xspace}
\newcommand{\abbreviation}[1]{\emph{#1}\onedot}
\newcommand{\ie}{\abbreviation{i.e}}
\newcommand{\eg}{\abbreviation{e.g}}
\newcommand{\cf}{\abbreviation{c.f}}
\newcommand{\etc}{\abbreviation{etc}}
\newcommand{\wrt}{\abbreviation{w.r.t}}
\newcommand{\dof}{\abbreviation{d.o.f}}
\newcommand{\etal}{\abbreviation{et al}}


% ----------------------------------------------------------------------------
% References
% ----------------------------------------------------------------------------
\let\secsym\S
\newcommand{\chap}[1]{\secsym\ref{#1}}
\renewcommand{\sec}[1]{\secsym\ref{#1}}
\newcommand{\subsec}[1]{\secsym\ref{#1}}
\newcommand{\fig}[1]{Figure \ref{#1}}
\newcommand{\eqn}[1]{Equation (\ref{#1})}
